name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  test:
    name: Go tests (unit + integration)
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: taskflow
          POSTGRES_PASSWORD: taskflow
          POSTGRES_DB: taskflow
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U taskflow -d taskflow"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=20

      nats:
        image: nats:2.10
        ports:
          - 4222:4222
          - 8222:8222
        options: >-
          --health-cmd="wget -qO- http://localhost:8222/varz >/dev/null 2>&1 || exit 1"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=20
        # JetStream enabled + monitoring endpoint on 8222
        command: ["-js", "-m", "8222"]

    env:
      # Your app config used by store/api/worker tests
      DATABASE_URL: postgres://taskflow:taskflow@localhost:5432/taskflow?sslmode=disable
      NATS_URL: nats://localhost:4222
      NATS_STREAM_NAME: TASKFLOW
      NATS_CONSUMER_NAME: taskflow-worker
      HTTP_PORT: "8080"
      LOG_LEVEL: info
      WORKER_CONCURRENCY: "10"
      WORKER_POLL_TIMEOUT: 2s
      WORKER_MAX_ATTEMPTS: "5"
      WORKER_BACKOFF_BASE: 500ms
      WORKER_BACKOFF_MAX: 10s

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
          cache: true

      - name: Install PostgreSQL client (psql)
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for Postgres
        run: |
          for i in {1..40}; do
            pg_isready -h localhost -p 5432 -U taskflow -d taskflow && exit 0
            sleep 1
          done
          echo "Postgres did not become ready in time" >&2
          exit 1

      - name: Run migrations
        run: |
          psql "$DATABASE_URL" -f api/deployments/migrations/001_init.sql

      - name: gofmt (check)
        run: |
          test -z "$(gofmt -l .)"

      - name: go vet
        run: |
          go vet ./...

      - name: Run tests
        run: |
          go test ./... -v
