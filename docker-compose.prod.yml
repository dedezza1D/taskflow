services:
  nginx:
    image: nginx:1.27-alpine
    restart: unless-stopped
    depends_on: [api, grafana]
    ports:
      - "80:80"
    volumes:
      - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks: [taskflow]

  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: taskflow
      POSTGRES_PASSWORD: taskflow
      POSTGRES_DB: taskflow
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./api/deployments/migrations:/docker-entrypoint-initdb.d:ro
    networks: [taskflow]

  nats:
    image: nats:2.10-alpine
    restart: unless-stopped
    command: ["-js", "-m", "8222"]
    networks: [taskflow]

  # NATS Prometheus exporter (internal only)
  nats-exporter:
    image: natsio/prometheus-nats-exporter:0.15.0
    restart: unless-stopped
    command:
      - "-connz"
      - "-routez"
      - "-subz"
      - "-varz"
      - "-jsz=all"
      - "http://nats:8222"
    depends_on:
      - nats
    networks: [taskflow]

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.108.0
    restart: unless-stopped
    command: ["--config=/etc/otelcol/config.yml"]
    volumes:
      - ./deploy/otel/otel-collector.yml:/etc/otelcol/config.yml:ro
    networks: [taskflow]

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    restart: unless-stopped
    environment:
      ENV: "prod"
      HTTP_PORT: "8080"
      LOG_LEVEL: "info"
      DATABASE_URL: "postgres://taskflow:taskflow@postgres:5432/taskflow?sslmode=disable"
      NATS_URL: "nats://nats:4222"
      NATS_STREAM_NAME: "TASKFLOW"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4318"
      OTEL_SERVICE_NAME: "taskflow-api"
    depends_on: [postgres, nats]
    networks: [taskflow]

  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    restart: unless-stopped
    environment:
      ENV: "prod"
      LOG_LEVEL: "info"
      DATABASE_URL: "postgres://taskflow:taskflow@postgres:5432/taskflow?sslmode=disable"
      NATS_URL: "nats://nats:4222"
      NATS_STREAM_NAME: "TASKFLOW"
      NATS_CONSUMER_NAME: "taskflow-worker"
      WORKER_CONCURRENCY: "20"
      WORKER_METRICS_PORT: "9091"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4318"
      OTEL_SERVICE_NAME: "taskflow-worker"
    depends_on: [postgres, nats]
    networks: [taskflow]

  prometheus:
    image: prom/prometheus:v2.55.0
    restart: unless-stopped
    volumes:
      - ./deploy/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks: [taskflow]

  grafana:
    image: grafana/grafana:11.2.0
    restart: unless-stopped
    environment:
      GF_SERVER_ROOT_URL: "%(protocol)s://%(domain)s/grafana/"
      GF_SERVER_SERVE_FROM_SUB_PATH: "true"
    volumes:
      - ./deploy/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./deploy/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    networks: [taskflow]

  tempo:
    image: grafana/tempo:2.6.0
    restart: unless-stopped
    command: ["-config.file=/etc/tempo.yml"]
    volumes:
      - ./deploy/tempo/tempo.yml:/etc/tempo.yml:ro
      - tempo_data:/tmp/tempo
    networks: [taskflow]

  loki:
    image: grafana/loki:3.1.0
    restart: unless-stopped
    command: ["-config.file=/etc/loki/config.yml"]
    volumes:
      - ./deploy/loki/loki-config.yml:/etc/loki/config.yml:ro
      - loki_data:/loki
    networks: [taskflow]

  promtail:
    image: grafana/promtail:3.1.0
    restart: unless-stopped
    command: ["-config.file=/etc/promtail/config.yml"]
    volumes:
      - ./deploy/promtail/promtail.yml:/etc/promtail/config.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks: [taskflow]

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:v0.16.0
    restart: unless-stopped
    environment:
      DATA_SOURCE_NAME: "postgresql://taskflow:taskflow@postgres:5432/taskflow?sslmode=disable"
    networks: [taskflow]

volumes:
  postgres_data:
  grafana_data:
  loki_data:
  tempo_data:

networks:
  taskflow:
    driver: bridge
