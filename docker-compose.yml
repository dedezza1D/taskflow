services:
  nginx:
    image: nginx:1.27-alpine
    depends_on:
      - api
      - grafana
    ports:
      - "8080:80"
    volumes:
      - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks: [taskflow]

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: taskflow
      POSTGRES_PASSWORD: taskflow
      POSTGRES_DB: taskflow
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./api/deployments/migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U taskflow"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks: [taskflow]

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:v0.16.0
    environment:
      DATA_SOURCE_NAME: "postgresql://taskflow:taskflow@postgres:5432/taskflow?sslmode=disable"
    depends_on:
      postgres:
        condition: service_healthy
    networks: [taskflow]

  nats:
    image: nats:2.10-alpine
    command: ["-js", "-m", "8222"]
    ports:
      - "8222:8222"
    networks: [taskflow]

  # Prometheus exporter for NATS (works even when NATS /metrics is not available)
  nats-exporter:
    image: natsio/prometheus-nats-exporter:0.15.0
    command:
      - "-connz"
      - "-routez"
      - "-subz"
      - "-varz"
      - "-jsz=all"
      - "http://nats:8222"
    depends_on:
      - nats
    networks: [taskflow]

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.108.0
    command: ["--config=/etc/otelcol/config.yml"]
    volumes:
      - ./deploy/otel/otel-collector.yml:/etc/otelcol/config.yml:ro
    ports:
      - "4317:4317"
      - "4318:4318"
    networks: [taskflow]

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    environment:
      ENV: "dev"
      HTTP_PORT: "8080"
      LOG_LEVEL: "info"
      DATABASE_URL: "postgres://taskflow:taskflow@postgres:5432/taskflow?sslmode=disable"
      NATS_URL: "nats://nats:4222"
      NATS_STREAM_NAME: "TASKFLOW"
      # Observability
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4318"
      OTEL_SERVICE_NAME: "taskflow-api"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks: [taskflow]

  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    environment:
      ENV: "dev"
      LOG_LEVEL: "info"
      DATABASE_URL: "postgres://taskflow:taskflow@postgres:5432/taskflow?sslmode=disable"
      NATS_URL: "nats://nats:4222"
      NATS_STREAM_NAME: "TASKFLOW"
      NATS_CONSUMER_NAME: "taskflow-worker"
      WORKER_CONCURRENCY: "10"
      WORKER_METRICS_PORT: "9091"
      # Observability
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4318"
      OTEL_SERVICE_NAME: "taskflow-worker"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started
    networks: [taskflow]

  prometheus:
    image: prom/prometheus:v2.55.0
    volumes:
      - ./deploy/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    networks: [taskflow]

  grafana:
    image: grafana/grafana:11.2.0
    environment:
      GF_SERVER_ROOT_URL: "%(protocol)s://%(domain)s:%(http_port)s/grafana/"
      GF_SERVER_SERVE_FROM_SUB_PATH: "true"
    ports:
      - "3000:3000"
    volumes:
      - ./deploy/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./deploy/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    networks: [taskflow]

  tempo:
    image: grafana/tempo:2.6.0
    command: ["-config.file=/etc/tempo.yml"]
    volumes:
      - ./deploy/tempo/tempo.yml:/etc/tempo.yml:ro
    ports:
      - "3200:3200"
    networks: [taskflow]

  loki:
    image: grafana/loki:3.1.0
    command: ["-config.file=/etc/loki/config.yml"]
    volumes:
      - ./deploy/loki/loki-config.yml:/etc/loki/config.yml:ro
      - loki_data:/loki
    ports:
      - "3100:3100"
    networks: [taskflow]

  promtail:
    image: grafana/promtail:3.1.0
    command: ["-config.file=/etc/promtail/config.yml"]
    volumes:
      - ./deploy/promtail/promtail.yml:/etc/promtail/config.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks: [taskflow]

volumes:
  postgres_data:
  grafana_data:
  loki_data:

networks:
  taskflow:
    driver: bridge
